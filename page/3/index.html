<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="thinkloki" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="在路上">
<meta property="og:type" content="website">
<meta property="og:title" content="thinkloki">
<meta property="og:url" content="http://wait.im/page/3/index.html">
<meta property="og:site_name" content="thinkloki">
<meta property="og:description" content="在路上">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="thinkloki">
<meta name="twitter:description" content="在路上">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://wait.im/page/3/"/>





  <title> thinkloki </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">thinkloki</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">做人不卖萌和咸鱼有什么区别</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            Sitemap
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://wait.im/2015/01/12/Android性能调优的技术点/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="thinkloki">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://source.wait.im/QNbCS5A.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="thinkloki">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="thinkloki" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/12/Android性能调优的技术点/" itemprop="url">
                  Android性能调优的技术点
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-01-12T12:23:36+08:00">
                2015-01-12
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="要点"><a href="#要点" class="headerlink" title="要点"></a>要点</h2><h3 id="使用异步"><a href="#使用异步" class="headerlink" title="使用异步"></a>使用异步</h3><ul>
<li>保持 APP 的高度响应，不要在 UI 线程做耗时操作，多使用异步任务</li>
<li>使用线程时要做好线程控制；使用队列、线程池</li>
<li>谨慎使用糟糕的 AysncTask 、 Timer</li>
<li>警惕异步任务引起的内存泄露</li>
<li>应该异步任务分类，比如 HTTP ，图片下载，文件读写，每一类的异步任务维护一个任务队列，而不是每一个任务都开一个线程（ Volley 表示我一个可以搞定这些全部 <em>(:з」∠)</em>）</li>
<li>这些常用的任务应该做好优先级处理（一般 JSON 数据优先于图片等静态数据的请求）</li>
<li>一般异步任务应该开启一个 SingleAsyncTask ，保证一时只有一个线程在工作</li>
<li>HTTP 和图片下载尽量使用同一套网络请求</li>
<li>使用 MVP 模式规范大型 Activity 类的行为，避免异步任务造成的内存泄露</li>
<li>避免内存泄露</li>
</ul>
<h3 id="了解虚拟机内存回收机制"><a href="#了解虚拟机内存回收机制" class="headerlink" title="了解虚拟机内存回收机制"></a>了解虚拟机内存回收机制</h3><ul>
<li>频繁 GC 也会造成卡顿，避免不必要的内存开销</li>
<li>错误的引用姿♂势造成的内存泄露（啊~要泄了~）</li>
<li>常见的 Activity 泄露（单例、 Application 、后台线程、无限动画、静态引用）</li>
<li>Bitmap 泄露（ HoneyComb 这个问题之前压力好大）</li>
<li>尽量使用 IntentService 代替 Service ，前者会自动 StopItself</li>
<li>排查内存泄露问题的方法（我一直以来都是简单暴力的人肉 dump 检查大法）</li>
<li>使用 LeakCanary 自动检查 Activity 泄露问题</li>
<li>对内存负载要保持敏感（ Sharp ）</li>
<li>视图优化</li>
</ul>
<h3 id="布局优化、减少层次，-Include-Merge"><a href="#布局优化、减少层次，-Include-Merge" class="headerlink" title="布局优化、减少层次， Include Merge"></a>布局优化、减少层次， Include Merge</h3><ul>
<li>使用 ViewStub 避免不必要的 LayoutInflate ，使用 GONE 代替重复 LayoutInflate 同一个布局</li>
<li>避免过度绘制，应该减少不必要的布局背景；布局层次太深会造成过度绘制以及 Measure 、 Layout 等方法时间复杂度的指数增长</li>
<li>使用过渡动画，比如给图片的呈现加一个轻量的淡入效果会让视觉上变得流畅许多</li>
<li>避免过度的动画，不要让一个界面同时出现多出动画，比如 List 滚动时 Item 项要停止播放动画或者 GIF</li>
<li>复杂动画使用 SurfaceView 或 TextureView</li>
<li>尽量提供多套分辨率的图片，使用矢量图</li>
</ul>
<h2 id="Adapter-优化"><a href="#Adapter-优化" class="headerlink" title="Adapter 优化"></a>Adapter 优化</h2><ul>
<li>复用 convertView ，用 ViewHolder 代替频繁 findViewById</li>
<li>不要重复 setListener ，要使用 v.getId 来复用 Listener ，不然会创建一堆 Listener 导致频繁 GC</li>
<li>多布局要采用 MutilItemView ，而不是使用一个大布局然后动态控制需要现实的部分</li>
<li>不要在 getView 方法做做耗时的操作</li>
<li>快速滚动列表的时候，可以停止加载列表项的图片，停止列表项的动画，不要在这时候改变列表项的布局</li>
<li>尽量用 RecyclerView （增量 Notify 和 RecycledViewPool 带你飞）</li>
</ul>
<h4 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h4><ul>
<li>算法优化，减少时间复杂度，参考一些经典的优化算法</li>
<li>尽量使用 int ，而不是 float 或者 double</li>
<li>尽量采用基本类型，避免无必要的自动装箱和拆箱，浪费时间和空间</li>
<li>选用合适的集合类（尽量以空间换时间）、选用 Android 家的 SparseArray,SparseBooleanArray 和 LongSparseArray</li>
<li>避免创建额外的对象（ StringBuilder ）</li>
<li>使用 SO 库完成一些比较独立的功能（高斯模糊）</li>
<li>预处理（提前操作）一些比较耗时的初始化工作统一放到启动图处理</li>
<li>懒加载（延迟处理）规避 Activity 的敏感生命周期</li>
<li>Log 工具类，要在编译时删掉调试代码，而不是在运行时通过判断条件规避</li>
<li>优先使用静态方法、公有方法还是公有方法？速度区别很大哦</li>
<li>类内部直接对成员变量进行操作，不要使用 getter/setter 方法，调用方法耗额外的时间</li>
<li>给内部类访问的外部类成员变量要声明称包内可访问，而不是私有，不然编译的时候还是会自动创建用于访问外部类成员变量的方法</li>
<li>遍历集合时，使用 i++代替 Iterator ，后者需要额外的对象操作，应在循环体内避免这种情况</li>
<li>如果一个基本类型或者 String 的值不会改变，尽量用 final static ，编译时会直接用变量的值替换变量，也就不需要在查询变量的值了</li>
</ul>
<h2 id="其他优化"><a href="#其他优化" class="headerlink" title="其他优化"></a>其他优化</h2><ul>
<li>数据库优化：使用索引、使用异步线程</li>
<li>网络优化 …… 一堆优秀的轮子</li>
<li>避免过度使用依赖注入框架，大量的反射</li>
<li>不过过度设计 /抽象，多态看起来很有设计感，代价就是额外的代码、空间、时间</li>
<li>尽量不要开启多进程，进程的开销很大</li>
</ul>
<h4 id="APK-瘦身"><a href="#APK-瘦身" class="headerlink" title="APK 瘦身"></a>APK 瘦身</h4><ul>
<li>开启混淆</li>
<li>使用 zipalign 工具优化 APK</li>
<li>适当有损图片压缩、使用矢量图</li>
<li>删除项目中冗余的资源，之前写过一些删除没有 res 资源的脚本</li>
<li>动态加载模块化，项目拆分啊！</li>
</ul>
<h4 id="性能问题的排查方法"><a href="#性能问题的排查方法" class="headerlink" title="性能问题的排查方法"></a>性能问题的排查方法</h4><ul>
<li>GPU 条形图，没事开来看看淘宝</li>
<li>过度绘制颜色，嗯，不要一篇姨妈红就好</li>
<li>LeakCanary ，自动检测 Activity 泄露，挺好用的</li>
<li>TraceView （ Device Monitor ）， Systrace ，分析哪些代码占用的 CPU 时间太大，屡试不爽</li>
<li>Lint ，检查不合理的 res 资源</li>
<li>layoutopt （还是 optlayout ？），对当前布局提出优化建议，已被 lint 替代，但是还能用</li>
<li>HierarchyViewer ，查看手机当前界面的布局层次，布局优化时常用（只用于模拟器，真机上用要 ROOT ，不想 ROOT 加得使用 ViewServer ）</li>
<li>StrictMode ， UI 操作、网络操作等容易出现性能问题的地方，如果出现异常情况 StrictMode 会报警</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://wait.im/2014/11/25/Leakcanary Square的一款Android:Java内存泄漏检测工具/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="thinkloki">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://source.wait.im/QNbCS5A.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="thinkloki">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="thinkloki" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/11/25/Leakcanary Square的一款Android:Java内存泄漏检测工具/" itemprop="url">
                  Leakcanary Square的一款Android/Java内存泄漏检测工具
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-11-25T00:14:36+08:00">
                2014-11-25
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p><a href="https://github.com/square/leakcanary" target="_blank" rel="external">Github地址</a></p>
</blockquote>
<p>##git readme:</p>
<p>###中文翻译@Jacksgong</p>
<blockquote>
<p>一款Android与Java的内存检测库<br>“A small leak will sink a gret ship.” - Benjamin Franklin</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/Jacksgong/leakcanary/master/assets/screenshot.png" alt=""></p>
<p>###I. 开始<br><code>build.gradle</code> 中的配置:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="section">dependencies</span> &#123;</div><div class="line">   <span class="attribute">debugCompile</span> <span class="string">'com.squareup.leakcanary:leakcanary-android:1.3'</span></div><div class="line">   releaseCompile <span class="string">'com.squareup.leakcanary:leakcanary-android-no-op:1.3'</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p><code>Application class</code>中的配置:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ExampleApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> public void onCreate() &#123;</div><div class="line">    <span class="keyword">super</span>.onCreate();</div><div class="line">    <span class="type">LeakCanary</span>.install(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样就可以了! 在debug包中activity内存泄漏将会被监听到，并且将会自动显示一个通知(show a notification)。</p>
<p>###II. 为什么要使用LeakCanary?<br>好问题! 我们已经在 <a href="http://squ.re/leakcanary" target="_blank" rel="external">博客文章</a>中回答了这个问题。</p>
<p>###III. 应该怎么使用它呢？<br>使用<code>RefWatcher</code>来监听引用是否已经被GC:</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="type">RefWatcher</span> refWatcher = <span class="meta">&#123;...&#125;</span>;</div><div class="line">// <span class="type">We</span> expect schrodingerCat to be gone soon (<span class="keyword">or</span> <span class="keyword">not</span>), <span class="keyword">let</span>'s watch it.</div><div class="line">// 我们预测shcrodingerCat很快会销毁(也许不会)，这里监听了它.</div><div class="line">refWatcher.watch(schrodingerCat);</div></pre></td></tr></table></figure>
<p><code>LeakCanary.install()</code>会返回预设的<code>RefWatcher</code>，并且安装了一个<code>ActivityRefWatcher</code>来监听activity调用了<code>Activity.onDestroy()</code>以后的泄漏。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ExampleApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">  public static <span class="type">RefWatcher</span> getRefWatcher(<span class="type">Context</span> context) &#123;</div><div class="line">    <span class="type">ExampleApplication</span> application = (<span class="type">ExampleApplication</span>) context.getApplicationContext();</div><div class="line">    <span class="keyword">return</span> application.refWatcher;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="type">RefWatcher</span> refWatcher;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> public void onCreate() &#123;</div><div class="line">    <span class="keyword">super</span>.onCreate();</div><div class="line">    refWatcher = <span class="type">LeakCanary</span>.install(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>你也可以使用<code>RefWatcher</code>来监听fragment的泄漏:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> public void onDestroy() &#123;</div><div class="line">    <span class="keyword">super</span>.onDestroy();</div><div class="line">    <span class="type">RefWatcher</span> refWatcher = <span class="type">ExampleApplication</span>.getRefWatcher(getActivity());</div><div class="line">    refWatcher.watch(<span class="keyword">this</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###IV. LeakCanary是如何工作的呢?</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">RefWatcher</span><span class="selector-class">.watch</span>()创建了一个<span class="selector-tag">KeyedWeakReference</span>到了监控的对象。</div><div class="line">之后，在后台线程，它检查引用是否已经被释放，如果没有它将促发一次<span class="selector-tag">GC</span>。</div><div class="line">如果引用依然没有被释放，它会导出<span class="selector-tag">heap</span>到存储在<span class="selector-tag">app</span>文件系统的<span class="selector-tag">a</span><span class="selector-class">.hprof</span>文件。</div><div class="line"><span class="selector-tag">HeapAnalyzerService</span>在单独的一个进程被启动，并且<span class="selector-tag">HeapAnalyzer</span>使用<span class="selector-tag">HAHA</span>来解析<span class="selector-tag">heap</span>。</div><div class="line"><span class="selector-tag">HeapAnalyzer</span>由于采用了单独的<span class="selector-tag">reference</span> <span class="selector-tag">key</span>，在<span class="selector-tag">heap</span> <span class="selector-tag">dump</span>中找到了<span class="selector-tag">KeyedWeakReference</span>并且定位到泄漏的引用。</div><div class="line"><span class="selector-tag">HeapAnalyzer</span>通过计算出到<span class="selector-tag">GC</span>根部最短路径的强引用来决定是否这里是泄漏了，并且建立导致泄漏的引用关系链。</div><div class="line">结果将传回在<span class="selector-tag">app</span>进程的<span class="selector-tag">DisplayLeakService</span>，并且显示泄漏通知。</div></pre></td></tr></table></figure>
<p>###V. 我应该如何拷贝leak trace呢？<br>可以在Logcat中看到leak trace:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="type">In</span> com.example.leakcanary:<span class="number">1.0</span>:<span class="number">1</span> com.example.leakcanary.<span class="type">MainActivity</span> has leaked:</div><div class="line">* <span class="type">GC</span> <span class="type">ROOT</span> thread java.lang.<span class="type">Thread</span>.&lt;<span class="type">Java</span> <span class="type">Local</span>&gt; (named <span class="symbol">'AsyncTask</span> #<span class="number">1</span>')</div><div class="line">* references com.example.leakcanary.<span class="type">MainActivity</span>$<span class="number">3.</span><span class="keyword">this</span>$<span class="number">0</span> (anonymous <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">android</span>.<span class="title">os</span>.<span class="title">AsyncTask</span>)</span></div><div class="line">* leaks com.example.leakcanary.<span class="type">MainActivity</span> instance</div><div class="line"></div><div class="line">* <span class="type">Reference</span> <span class="type">Key</span>: e71f3bf5-d786<span class="number">-4145</span><span class="number">-8539</span><span class="number">-584</span>afaecad1d</div><div class="line">* <span class="type">Device</span>: <span class="type">Genymotion</span> generic <span class="type">Google</span> <span class="type">Nexus</span> <span class="number">6</span> - <span class="number">5.1</span><span class="number">.0</span> - <span class="type">API</span> <span class="number">22</span> - <span class="number">1440</span>x2560 vbox86p</div><div class="line">* <span class="type">Android</span> <span class="type">Version</span>: <span class="number">5.1</span> <span class="type">API</span>: <span class="number">22</span></div></pre></td></tr></table></figure>
<p>也可以从action bar menu分享leak trace与heap dump文件。</p>
<p>###VI. 应该如何解决内存泄漏呢?<br>一旦拥有了leak trace，就可以分析出哪个路径中的引用不应该存在，然后分析出引用依然存在的原因。通常情况是注册的监听没有反注册，或者是<code>close()</code>方法没有调用，或者是一个未知的类((通常也是没有句柄的对象，就纯new出来执行了某方法)hold住了外部类的引用。如果你分析不出你代码中的问题，别放弃，可以在Stack Overflow question(使用<code>leakcanary</code> 标签)中创建相关问题。</p>
<p>###VII. 我的泄漏是因为执行Android SDK导致的！<br>随着时间的推移，已经有一些已知的由于Android SDK的执行导致的内存泄漏得到了作为生厂商AOSP的修复。当发生这样的内存泄漏的时候，其实我们作为应用开发者能做的很少。对于这样的问题，LeakCanary已经有内建了一个忽略已知Android SDK泄漏的列表: <a href="https://github.com/square/leakcanary/blob/master/library/leakcanary-android/src/main/java/com/squareup/leakcanary/AndroidExcludedRefs.java" target="_blank" rel="external">AndroidExcludedRefs.java</a>。如果你发现了新的，请提供leak trace、reference key、设备版本与Android版来<a href="https://github.com/square/leakcanary/issues/new" target="_blank" rel="external">创建问题</a>，当然如果能够提供一个heap dump的文件连接更好。</p>
<p>这对于新发布的Android来说是特别重要的，你有机会能够帮助尽早发现新的内存泄漏，使整个Android社区受益。</p>
<p>开发版本的快照: <a href="https://oss.sonatype.org/content/repositories/snapshots/" target="_blank" rel="external">Sonatype’s snapshots repository</a>。</p>
<p>###VIII. 超出leak trace范围</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">通常leak <span class="keyword">trace</span>是不够的，还需要通过MAT或者YourKit来深挖heap dump，下面是你如何通过heap dump来找出泄漏:</div><div class="line">找到com.squareup.leakcanary.KeyedWeakReference所有的实例。</div><div class="line">对于每个实例，查看它的<span class="built_in">key</span>成员变量。</div><div class="line">找到包含与LeakCanary报出的reference <span class="built_in">key</span>相同<span class="built_in">key</span>成员变量的KeyedWeakReference。</div><div class="line">那么这个KeyedWeakReference中的reference成员变量，就是你泄漏了的对象。</div><div class="line">到此为止，剩余的工作就是，开始查找到GC Roots最短路径(不包含弱引用)。</div></pre></td></tr></table></figure>
<p>###IX. 定制<br>图标与标注(Icon and Label)</p>
<p>DisplayLeakActivity默认是使用默认的图标与标注，当然你可以通过在你的app中提供<code>R.drawable.__leak_canary_icon</code>与<code>R.string.__leak_canary_display_activity_label</code>来定制这个:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">res/</div><div class="line">  drawable-hdpi/</div><div class="line">    __leak_canary_icon<span class="selector-class">.png</span></div><div class="line">  drawable-mdpi/</div><div class="line">    __leak_canary_icon<span class="selector-class">.png</span></div><div class="line">  drawable-xhdpi/</div><div class="line">    __leak_canary_icon<span class="selector-class">.png</span></div><div class="line">  drawable-xxhdpi/</div><div class="line">    __leak_canary_icon<span class="selector-class">.png</span></div><div class="line">  drawable-xxxhdpi/</div><div class="line">    __leak_canary_icon.png</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">"__leak_canary_display_activity_label"</span>&gt;</span>MyLeaks<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></div></pre></td></tr></table></figure>
<p>####存储leak traces</p>
<p><code>DisplayLeakActivity</code>最多在app目录中存储7个heap dumps与leak traces 文件。你可以通过在你的app中提供<code>R.integer.__leak_canary_max_stored_leaks</code>来定制这个:</p>
<p>####上传到服务器</p>
<p>可以通过修改默认的行为来上传leak trace与heap dump到指定的服务器。</p>
<p>创建一个你自己的<code>AbstractAnalysisResultService</code>。最简单的方法是在debug的app中继承<code>DefaultAnalysisResultService</code>:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">LeakUploadService</span> <span class="keyword">extends</span> <span class="title">DefaultAnalysisResultService</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span> <span class="keyword">protected</span> void afterDefaultHandling(<span class="type">HeapDump</span> heapDump, <span class="type">AnalysisResult</span> result, <span class="type">String</span> leakInfo) &#123;</div><div class="line">    <span class="keyword">if</span> (!result.leakFound || result.excludedLeak) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    myServer.uploadLeakBlocking(heapDump.heapDumpFile, leakInfo);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>要确认发布的Application类使用无效的RefWatcher:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ExampleApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">  public static <span class="type">RefWatcher</span> getRefWatcher(<span class="type">Context</span> context) &#123;</div><div class="line">    <span class="type">ExampleApplication</span> application = (<span class="type">ExampleApplication</span>) context.getApplicationContext();</div><div class="line">    <span class="keyword">return</span> application.refWatcher;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="type">RefWatcher</span> refWatcher;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span> public void onCreate() &#123;</div><div class="line">    <span class="keyword">super</span>.onCreate();</div><div class="line">    refWatcher = installLeakCanary();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">protected</span> <span class="type">RefWatcher</span> installLeakCanary() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="type">RefWatcher</span>.<span class="type">DISABLED</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在你debug的Application类中创建一个自定义的RefWatcher:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DebugExampleApplication</span> <span class="keyword">extends</span> <span class="title">ExampleApplication</span> </span>&#123;</div><div class="line">  <span class="keyword">protected</span> <span class="type">RefWatcher</span> installLeakCanary() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="type">LeakCanary</span>.install(app, <span class="type">LeakUploadService</span>.<span class="keyword">class</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>不要忘了在debug的manifest里面注册service:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></div><div class="line">    &gt;</div><div class="line">  <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:name</span>=<span class="string">"com.example.DebugExampleApplication"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">"com.example.LeakUploadService"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">application</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div></pre></td></tr></table></figure>
<p>你也可以上传leak traces到Slack或者HipChat，<a href="https://gist.github.com/pyricau/06c2c486d24f5f85f7f0" target="_blank" rel="external">这里是一个例子</a></p>
<p><img src="https://raw.githubusercontent.com/Jacksgong/leakcanary/master/assets/icon_512.png" alt=""><br>LeakCanary名称是为了表达<a href="http://en.wiktionary.org/wiki/canary_in_a_coal_mine" target="_blank" rel="external">canary in a coal mine</a>，因为LeakCanary是通过提供危险预警，检测风险的哨兵，维护者@edenman提的建议!</p>
<p>###X. License</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Copyright 2015 Square, Inc.</div><div class="line"></div><div class="line">Licensed under the Apache License, Version 2.0 (the "License");</div><div class="line">you may not <span class="keyword">use</span> this <span class="keyword">file</span> <span class="keyword">except</span> <span class="keyword">in</span> compliance <span class="keyword">with</span> the License.</div><div class="line">You may obtain a copy <span class="keyword">of</span> the License <span class="keyword">at</span></div><div class="line"></div><div class="line">   <span class="keyword">http</span>://www.apache.org/licenses/LICENSE<span class="number">-2.0</span></div><div class="line"></div><div class="line">Unless <span class="keyword">required</span> <span class="keyword">by</span> applicable law <span class="keyword">or</span> agreed <span class="keyword">to</span> <span class="keyword">in</span> writing, software</div><div class="line"><span class="keyword">distributed</span> <span class="keyword">under</span> the License <span class="keyword">is</span> <span class="keyword">distributed</span> <span class="keyword">on</span> an <span class="string">"AS IS"</span> BASIS,</div><div class="line"><span class="keyword">WITHOUT</span> WARRANTIES <span class="keyword">OR</span> CONDITIONS <span class="keyword">OF</span> <span class="keyword">ANY</span> KIND, either express <span class="keyword">or</span> implied.</div><div class="line">See the License <span class="keyword">for</span> the specific <span class="keyword">language</span> governing permissions <span class="keyword">and</span></div><div class="line">limitations <span class="keyword">under</span> the License.</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://wait.im/2014/06/21/SVG Android应用探究之路/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="thinkloki">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://source.wait.im/QNbCS5A.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="thinkloki">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="thinkloki" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/06/21/SVG Android应用探究之路/" itemprop="url">
                  SVG Android应用探究之路
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-06-21T00:12:36+08:00">
                2014-06-21
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h5 id="优点"><a href="#优点" class="headerlink" title="优点:"></a>优点:</h5><ul>
<li>vector</li>
<li>在所有大小分辨率屏幕上完美显示</li>
<li>SVG图片更小</li>
<li>一张图片可以更具需求多次使用？(One picture is used some times for different permissions)</li>
<li>减少加载时间</li>
</ul>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点:"></a>缺点:</h5><p>图片只能按照比例缩放<br>不支持透明度？<br>svg文件还可以近一步优化，里面有一些不可取（The schedule needs to be simplified — the more vector elements, the the file more weighs. It is undesirable to use shades and luminescences as it in times increases the size of SVG-files）</p>
<h4 id="SVG-的探索来源于："><a href="#SVG-的探索来源于：" class="headerlink" title="SVG 的探索来源于："></a>SVG 的探索来源于：</h4><figure class="highlight ada"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">No sooner said than done. So, under katom history <span class="keyword">of</span> introduction <span class="keyword">of</span> vector images </div><div class="line"><span class="keyword">in</span> one <span class="keyword">of</span> our applications. <span class="keyword">In</span> article we will impart experience also features <span class="keyword">of</span> </div><div class="line"><span class="keyword">use</span> <span class="keyword">of</span> vector images <span class="keyword">in</span> format SVG <span class="keyword">in</span> applications Android.</div></pre></td></tr></table></figure>
<h4 id="编辑器：Adobe-Illustrator-、Inkscape-work"><a href="#编辑器：Adobe-Illustrator-、Inkscape-work" class="headerlink" title="编辑器：Adobe Illustrator 、Inkscape work."></a>编辑器：Adobe Illustrator 、Inkscape work.</h4><h4 id="Google-“android-svg”"><a href="#Google-“android-svg”" class="headerlink" title="Google “android svg”:"></a>Google “android svg”:</h4><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">projects on guglokode:</div><div class="line"><span class="selector-tag">code</span><span class="selector-class">.google</span><span class="selector-class">.com</span>/p/svg-android/</div><div class="line"><span class="selector-tag">code</span><span class="selector-class">.google</span><span class="selector-class">.com</span>/p/svg-android-<span class="number">2</span>/</div><div class="line">Detailed <span class="selector-tag">article</span> about use NDK:</div><div class="line">horribileru<span class="selector-class">.blogspot</span><span class="selector-class">.ru</span>/<span class="number">2011</span>/<span class="number">10</span>/android-imageview-svg<span class="selector-class">.html</span></div><div class="line">And some links to dead projects at different forums.</div></pre></td></tr></table></figure>
<h4 id="一、SVG-Android："><a href="#一、SVG-Android：" class="headerlink" title="一、SVG-Android："></a>一、SVG-Android：</h4><h5 id="GitHub-https-github-com-search-utf8-✓-amp-q-SVG-Android"><a href="#GitHub-https-github-com-search-utf8-✓-amp-q-SVG-Android" class="headerlink" title="GitHub: https://github.com/search?utf8=✓&amp;q=SVG-Android"></a>GitHub: <a href="https://github.com/search?utf8=✓&amp;q=SVG-Android" target="_blank" rel="external">https://github.com/search?utf8=✓&amp;q=SVG-Android</a></h5><p>他们项目通过底层封装的接口方式：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">SVG svg = SVGParser.getSVGFromResource(getResources(), R.raw.filename)<span class="comment">;</span></div><div class="line">Drawable drawable = svg.createPictureDrawable()<span class="comment">;</span></div><div class="line">imageView.setImageDrawable(drawable)<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>缺点: 只支持 SVG basic 1.1(不支持Inkspace编辑、只支持AdobeIllustrator编辑)</p>
<h4 id="二、-SVG-Android-2"><a href="#二、-SVG-Android-2" class="headerlink" title="二、 SVG-Android-2:"></a>二、 SVG-Android-2:</h4><h4 id="URL-https-code-google-com-p-svg-android-2-wiki-Introduction"><a href="#URL-https-code-google-com-p-svg-android-2-wiki-Introduction" class="headerlink" title="URL: https://code.google.com/p/svg-android-2/wiki/Introduction"></a>URL: <a href="https://code.google.com/p/svg-android-2/wiki/Introduction" target="_blank" rel="external">https://code.google.com/p/svg-android-2/wiki/Introduction</a></h4><h5 id="第一个发现：SVG在包含-阴影的情况下大小会飙升："><a href="#第一个发现：SVG在包含-阴影的情况下大小会飙升：" class="headerlink" title="第一个发现：SVG在包含 阴影的情况下大小会飙升："></a>第一个发现：SVG在包含 阴影的情况下大小会飙升：</h5><p><img src="http://blog.dreamtobe.cn/img/svg-k-1.png" alt="ICON1"><br>izorbrazhenija with a shade and without: 118 KB vs 1 KB</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">解决方法：删除对应的阴影</div></pre></td></tr></table></figure>
<h5 id="第二个发现：显示梯度颜色，不支持！"><a href="#第二个发现：显示梯度颜色，不支持！" class="headerlink" title="第二个发现：显示梯度颜色，不支持！"></a>第二个发现：显示梯度颜色，不支持！</h5><p>The problem with gradients has dared removal of superfluous tags from svg (it is described further in article). But basically, and with it it would be possible to live and in our simple images to replace a gradient with homogeneous pouring, if not other nuance — considerable load time of images.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">解决方法：用简单的图片代替</div></pre></td></tr></table></figure>
<p>后文(第三个发现)提到解决方法： After we have got rid of the given links, having edited code SVG in some images, the gradient began to be displayed correctly.<br><img src="http://blog.dreamtobe.cn/img/svg-k-2.png" alt="icon 2"><br>at the left — the black sky in the form of a gradient, on the right — a correct picture.</p>
<h5 id="第三个发现：加载时间"><a href="#第三个发现：加载时间" class="headerlink" title="第三个发现：加载时间"></a>第三个发现：加载时间</h5><p>根源：为什么SVG-Android-2这么耗时，</p>
<p>原因：SVGParser 解析Image XML file ，解析了两次，第一次 为第二次解析收集多余的属性。多余信息是：</p>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="literal">that</span> the most interesting, — <span class="keyword">is</span> analyzed only attribute xlink:href which <span class="keyword">is</span> a</div><div class="line">semblance <span class="keyword">of</span> hyperlinks <span class="keyword">in</span> the <span class="built_in">document</span>. In our problem images just there were</div><div class="line">such links, <span class="keyword">and</span> they conducted anywhere.</div></pre></td></tr></table></figure>
<p>成果：耗时，加载35个SVG的图片(PNG 500px*500px)：从原8s 减少到 1.8-2s。</p>
<h5 id="第四个发现：透明与颜色适配器"><a href="#第四个发现：透明与颜色适配器" class="headerlink" title="第四个发现：透明与颜色适配器"></a>第四个发现：透明与颜色适配器</h5><p>原因：库不是加载 典型的bitmapDrawable与pictureDrawable,并且源码中的setColorFilter、setAlpha方法都是空的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public void setColorFilter(ColorFilter colorFilter) &#123;&#125;</div><div class="line">@Override</div><div class="line">public void setAlpha(int alpha) &#123;&#125;</div></pre></td></tr></table></figure>
<p>成果：在SVGHandler中发现一个Paint类型的fillPaint组件，如果能够在加载元素之前 创建colorFilter即可，略微调整SVGHandler加载SVG的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFilterColor</span><span class="params">(<span class="keyword">int</span> filterColor)</span> </span>&#123;</div><div class="line">    fillPaint.setColorFilter(<span class="keyword">new</span> PorterDuffColorFilter(filterColor, Mode.MULTIPLY));</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>接口调整为：</p>
<figure class="highlight fix"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">SVG svg </span>=<span class="string"> SVGParser.getSVGFromResource(getResources(), rawSvgId, filterColor);</span></div></pre></td></tr></table></figure>
<p>因此我们能够在多张图片上通过引用一张图片使用不同的阴影颜色（As a result we could receive some images of different shades from one picture.）</p>
<p>对于透明度，建议并不适用setAlpha去实现（实际上是可以的通过fillPaint）:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Also <span class="keyword">it</span> is possible <span class="built_in">to</span> establish <span class="keyword">and</span> Alpha <span class="keyword">for</span> fillPaint, but <span class="keyword">in</span> games this property is required <span class="keyword">in</span> <span class="keyword">the</span> dynamic form (have pressed <span class="keyword">an</span> <span class="keyword">element</span> — has become translucent), <span class="keyword">and</span> podgruzhat <span class="keyword">each</span> <span class="built_in">time</span> <span class="keyword">the</span> <span class="built_in">new</span> image is inconvenient. Therefore this effect have replaced <span class="keyword">with</span> scaling (have pressed — <span class="keyword">the</span> <span class="keyword">element</span> has decreased).</div></pre></td></tr></table></figure>
<h5 id="第五个发现：异常处理："><a href="#第五个发现：异常处理：" class="headerlink" title="第五个发现：异常处理："></a>第五个发现：异常处理：</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">java<span class="selector-class">.lang</span><span class="selector-class">.UnsupportedOperationException</span></div><div class="line">  at android<span class="selector-class">.view</span><span class="selector-class">.GLES20Canvas</span><span class="selector-class">.drawPicture</span>(GLES20Canvas<span class="selector-class">.java</span>:<span class="number">895</span>)</div><div class="line">  at android<span class="selector-class">.graphics</span><span class="selector-class">.drawable</span><span class="selector-class">.PictureDrawable</span><span class="selector-class">.draw</span>(PictureDrawable<span class="selector-class">.java</span>:<span class="number">73</span>)</div></pre></td></tr></table></figure>
<p>低版本不支持gpu(api &lt; 11)</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">setSoftwareLayerType</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     view.setLayerType(View.LAYER_TYPE_SOFTWARE, <span class="keyword">null</span>);</div><div class="line">   &#125; <span class="keyword">catch</span> (NoSuchMethodError e) &#123;</div><div class="line">       <span class="comment">//Do nothing - this happens on API &lt; 11</span></div><div class="line">   &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="使用SVG的项目："><a href="#使用SVG的项目：" class="headerlink" title="使用SVG的项目："></a>使用SVG的项目：</h4><p><a href="http://play.google.com/store/apps/details?id=com.whisperarts.kids.forms" target="_blank" rel="external">http://play.google.com/store/apps/details?id=com.whisperarts.kids.forms</a></p>
<blockquote>
<p>本文总结自：<a href="http://sysmagazine.com/posts/166093/" target="_blank" rel="external">http://sysmagazine.com/posts/166093/</a></p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://wait.im/2014/03/02/Hexo上第一篇博文/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="thinkloki">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://source.wait.im/QNbCS5A.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="thinkloki">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="thinkloki" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/03/02/Hexo上第一篇博文/" itemprop="url">
                  Hexo上的第一篇博文
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2014-03-02T00:18:36+08:00">
                2014-03-02
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是使用Hexo搭建的博客后写的第一篇博文，搭建的过程还算顺利，写代码也写了两年了，觉得去总结一下也挺好，以后会把自己平时遇到的一些问题总结出来，码农也要学会总结，去提高自己。</p>
<p><a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>，特别感谢Hexo，上面的介绍已经非常详细了，感觉比搜出来的一些博文稍微靠谱一点。Node.js装环境的时候遇到不少问题，Hexo官网上都有非常好的解决方案，言简意赅。还要感谢前辈们的总结，在建博客的时候对我的帮助也不少。加油！！！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://wait.im/2013/10/25/Android清理内存/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="thinkloki">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="http://source.wait.im/QNbCS5A.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="thinkloki">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="thinkloki" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/10/25/Android清理内存/" itemprop="url">
                  Android清理内存
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2013-10-25T00:16:36+08:00">
                2013-10-25
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Android内存清理，利用ActivityManager获取当前正在运行的进程，清理这些进程释放内存。</p>
<p>可以根据importance的不同来判断前台或后台RunningAppProcessInfo 里面的常量IMOPORTANCE就是上面所说的前台后台，其实IMOPORTANCE是表示这个app进程的重要性，因为系统回收时候，会根据IMOPORTANCE来回收进程的。具体可以去看文档。。</p>
<p>在配置文件中添加权限</p>
<uses-permission android:name="”android.permission.KILL_BACKGROUND_PROCESSES”/">

<p>内存清理代码以及获取系统内存和各个APP占用内存代码如下：</p>
<figure class="highlight zephir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by thinkloki on 2013/8/20.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SystemUtil</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获取可用内存</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> getAvailMemory(Context context) &#123;</div><div class="line">        ActivityManager am = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</div><div class="line">        ActivityManager.MemoryInfo mi = <span class="keyword">new</span> ActivityManager.MemoryInfo();</div><div class="line">        am.getMemoryInfo(mi);</div><div class="line">        <span class="keyword">return</span> mi.availMem / (<span class="number">1024</span> * <span class="number">1024</span>);</div><div class="line"> </div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获取总内存</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> getTotalMemory(Context context) &#123;</div><div class="line">        String str1 = <span class="string">"/proc/meminfo"</span>;<span class="comment">// 系统内存信息文件</span></div><div class="line">        String str2;</div><div class="line">        String[] arrayOfString;</div><div class="line">        <span class="keyword">long</span> initial_memory = <span class="number">0</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            FileReader localFileReader = <span class="keyword">new</span> FileReader(str1);</div><div class="line">            BufferedReader localBufferedReader = <span class="keyword">new</span> BufferedReader(</div><div class="line">                    localFileReader, <span class="number">8192</span>);</div><div class="line">            str2 = localBufferedReader.readLine();<span class="comment">// 读取meminfo第一行，系统总内存大小</span></div><div class="line">            arrayOfString = str2.split(<span class="string">"\\s+"</span>);</div><div class="line">            initial_memory = Integer.valueOf(arrayOfString[<span class="number">1</span>]).intValue() * <span class="number">1024</span>;<span class="comment">// 获得系统总内存，单位是KB，乘以1024转换为Byte</span></div><div class="line">            localBufferedReader.close();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> initial_memory / (<span class="number">1024</span> * <span class="number">1024</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line"><span class="comment">//    public static final int IMPORTANCE_BACKGROUND = 400//后台</span></div><div class="line"><span class="comment">//    public static final int IMPORTANCE_EMPTY = 500//空进程</span></div><div class="line"><span class="comment">//    public static final int IMPORTANCE_SERVICE = 300//在服务中</span></div><div class="line"><span class="comment">//    public static final int IMPORTANCE_VISIBLE = 200//在屏幕前端、获取不到焦点可理解为</span></div><div class="line"><span class="comment">//    public static final int IMPORTANCE_FOREGROUND = 100//在屏幕最前端、可获取到焦点 可理解为Activity生命周期的OnResume();</span></div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 清理内存</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void clearMemory(Context context) &#123;</div><div class="line">        ActivityManager activityManger = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</div><div class="line">        <span class="keyword">List</span>&lt;ActivityManager.RunningAppProcessInfo&gt; <span class="keyword">list</span> = activityManger.getRunningAppProcesses();</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">list</span> != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">list</span>.size(); i++) &#123;</div><div class="line">                ActivityManager.RunningAppProcessInfo apinfo = <span class="keyword">list</span>.get(i);</div><div class="line">                String[] pkgList = apinfo.pkgList;</div><div class="line">                <span class="keyword">if</span> (apinfo.importance &gt; ActivityManager.RunningAppProcessInfo.IMPORTANCE_VISIBLE) &#123;</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; pkgList.length; j++) &#123;</div><div class="line">                        <span class="comment">/**清理不可用的内容空间**/</span></div><div class="line">                        activityManger.killBackgroundProcesses(pkgList[j]);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 获取每个APP占用的内存</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void getEveryAppMemory(Context context) &#123;</div><div class="line">        ActivityManager am = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);</div><div class="line">        <span class="keyword">List</span>&lt;ActivityManager.RunningAppProcessInfo&gt; <span class="keyword">list</span> = am.getRunningAppProcesses();</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">list</span> != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">list</span>.size(); i++) &#123;</div><div class="line">                ActivityManager.RunningAppProcessInfo appinfo = <span class="keyword">list</span>.get(i);</div><div class="line">                <span class="keyword">int</span>[] myMempid = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;appinfo.pid&#125;;</div><div class="line">                Debug.MemoryInfo[] appMem = am.getProcessMemoryInfo(myMempid);</div><div class="line">                <span class="keyword">int</span> memSize = appMem[<span class="number">0</span>].dalvikPrivateDirty / <span class="number">1024</span>;</div><div class="line">                Log.e(<span class="string">"AppMemory"</span>, appinfo.processName + <span class="string">":"</span> + memSize);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 清理应用缓存</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> context</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void clearAppCache(Context context) &#123;</div><div class="line">        File[] dir = context.getCacheDir().listFiles();</div><div class="line">        <span class="keyword">if</span> (dir != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (File f : dir) &#123;</div><div class="line">                f.delete();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</uses-permission>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>


          
          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://source.wait.im/QNbCS5A.jpg"
               alt="thinkloki" />
          <p class="site-author-name" itemprop="name">thinkloki</p>
          <p class="site-description motion-element" itemprop="description">在路上</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">thinkloki</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
